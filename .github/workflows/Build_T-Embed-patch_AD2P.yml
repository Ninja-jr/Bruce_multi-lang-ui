name: Build_T-Embed-Patch A2DP

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to build from'
        required: true
        default: 'dev'
        type: string
      version_name:
        description: 'Version name (Ninja-Jr 1.0, Ninja-Jr dev, etc)'
        required: true
        default: 'Ninja-Jr dev'
        type: string
      auto_patch:
        description: 'Auto-patch A2DP library on failure?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write

jobs:
  compile_sketch:
    name: Build lilygo-t-embed-cc1101 with Auto-Patch
    runs-on: ubuntu-latest
    env:
      BOARD_ENV: "lilygo-t-embed-cc1101"
      SHOULD_PATCH: ${{ github.event.inputs.auto_patch }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch }}
          token: ${{ secrets.SYNC_PAT }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-multilib libc6-dev-i386

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install requests esptool intelhex

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: Bruce-platformio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: Bruce-platformio-

      - name: Restore PIO Build Cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ github.workspace }}/.pio
          key: Bruce-pio-${{ env.BOARD_ENV }}-${{ github.run_id }}-${{ github.run_attempt }}
          restore-keys: |
            Bruce-pio-${{ env.BOARD_ENV }}-

      - name: Install PlatformIO and configure version
        run: |
          pip install platformio
          sed -i "s/-DBRUCE_VERSION=/-DBRUCE_VERSION='\"${{ github.event.inputs.version_name }}\"' ; /g" ./platformio.ini
          GIT_HASH=$(git describe --always --dirty)
          sed -i "s|-DGIT_COMMIT_HASH='\"Homebrew\"'|!echo '-DGIT_COMMIT_HASH=\\\\\\\\\"${GIT_HASH}\\\\\\\\\"'|g" ./platformio.ini

      - name: Compile for lilygo-t-embed-cc1101
        id: compile
        run: |
          platformio run -e ${{ env.BOARD_ENV }}

      - name: Debug A2DP Platform on Failure
        if: failure() && env.SHOULD_PATCH == 'true'
        id: debug_a2dp
        run: |
          HEADER=$(find .pio -name "BluetoothA2DPCommon.h" -type f 2>/dev/null | head -1)
          if [ -f "$HEADER" ]; then
            ERROR_CONTEXT=$(grep -n "#error" "$HEADER" -B20 -A5)
            echo "error_context<<EOF" >> $GITHUB_OUTPUT
            echo "$ERROR_CONTEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "header_path=$HEADER" >> $GITHUB_OUTPUT
            PLATFORM_LOGIC=$(sed -n '20,60p' "$HEADER")
            echo "platform_logic<<EOF" >> $GITHUB_OUTPUT
            echo "$PLATFORM_LOGIC" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Patched A2DP Library
        if: steps.debug_a2dp.outputs.header_path && env.SHOULD_PATCH == 'true'
        run: |
          ORIG_HEADER="${{ steps.debug_a2dp.outputs.header_path }}"
          ORIG_DIR=$(dirname "$ORIG_HEADER")
          PATCHED_DIR="lib/ESP32-A2DP-patched"
          mkdir -p "$PATCHED_DIR/src"
          cp -r "$ORIG_DIR"/* "$PATCHED_DIR/src/" 2>/dev/null || true
          PATCHED_HEADER="$PATCHED_DIR/src/BluetoothA2DPCommon.h"
          if [ -f "$PATCHED_HEADER" ]; then
            cp "$PATCHED_HEADER" "$PATCHED_HEADER.bak"
            sed -i '33s/#error.*$/\/\/ [PATCHED] #error "Platform check disabled"/' "$PATCHED_HEADER"
            sed -i 's/#if defined(ARDUINO_ARCH_ESP32)/#if 1 \/\/ [PATCHED] Force platform/' "$PATCHED_HEADER" 2>/dev/null || true
            sed -i 's/#ifdef ARDUINO/#if 1 \/\/ [PATCHED] Force ARDUINO/' "$PATCHED_HEADER" 2>/dev/null || true
          fi
          cat > "$PATCHED_DIR/library.json" << EOF
{
  "name": "ESP32-A2DP-patched",
  "version": "1.8.8-bruce-patched",
  "description": "ESP32-A2DP patched for Bruce firmware",
  "keywords": ["a2dp", "bluetooth", "audio", "esp32"],
  "authors": [
    {
      "name": "Phil Schatzmann",
      "maintainer": true
    }
  ],
  "repository": {
    "type": "git",
    "url": "https://github.com/${{ github.repository }}"
  },
  "frameworks": ["arduino"],
  "platforms": ["espressif32"],
  "headers": ["BluetoothA2DPCommon.h", "BluetoothA2DPSource.h", "BluetoothA2DPSink.h"]
}
EOF

      - name: Update platformio.ini with Patched Library
        if: steps.debug_a2dp.outputs.header_path && env.SHOULD_PATCH == 'true'
        run: |
          cp platformio.ini platformio.ini.backup
          sed -i 's|pschatzmann/ESP32-A2DP.*|./lib/ESP32-A2DP-patched|g' platformio.ini
          sed -i 's|https://github.com/pschatzmann/ESP32-A2DP.*|./lib/ESP32-A2DP-patched|g' platformio.ini
          sed -i 's|pschatzmann/esp32-a2dp.*|./lib/ESP32-A2DP-patched|g' platformio.ini

      - name: Commit and Push Patched Library
        if: steps.debug_a2dp.outputs.header_path && env.SHOULD_PATCH == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          CURRENT_BRANCH="${{ github.head_ref || github.ref_name }}"
          CURRENT_BRANCH=${CURRENT_BRANCH#refs/heads/}
          git checkout "$CURRENT_BRANCH"
          git add lib/ESP32-A2DP-patched/
          git add platformio.ini
          if ! git diff --cached --quiet; then
            git commit -m "ðŸ”§ Auto-patch: Add patched ESP32-A2DP library
            
            Platform detection patched for Bruce firmware
            - Disabled unsupported platform error
            - Auto-generated by GitHub Actions run #${{ github.run_number }}
            
            Build env: ${{ env.BOARD_ENV }}
            Version: ${{ github.event.inputs.version_name }}"
            git push origin "$CURRENT_BRANCH"
          fi

      - name: Retry Build with Patched Library
        if: steps.debug_a2dp.outputs.header_path && env.SHOULD_PATCH == 'true'
        run: |
          platformio run -e ${{ env.BOARD_ENV }}

      - name: Save PIO Build Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ github.workspace }}/.pio
          key: Bruce-pio-${{ env.BOARD_ENV }}-${{ github.run_id }}-${{ github.run_attempt }}

      - name: Upload Binary Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Bruce-${{ env.BOARD_ENV }}-${{ github.event.inputs.version_name }}
          path: |
            Bruce-*.bin
            Bruce-*.elf
            Bruce-*.map
          retention-days: 30
          if-no-files-found: error

      - name: Display Build Info
        if: always()
        run: |
          if [ -f "Bruce-*.bin" ]; then
            echo "Build successful!"
            echo "Environment: ${{ env.BOARD_ENV }}"
            echo "Version: ${{ github.event.inputs.version_name }}"
            echo "Git Hash: $(git describe --always --dirty)"
            ls -la Bruce-*.* 2>/dev/null || echo "No Bruce files"
          else
            echo "Build failed"
            echo "A2DP patching attempted: ${{ env.SHOULD_PATCH }}"
          fi
