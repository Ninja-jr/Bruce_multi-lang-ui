name: Build_T-Embed-Patch A2DP

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to build from'
        required: true
        default: 'dev'
        type: string
      version_name:
        description: 'Version name (Ninja-Jr 1.0, Ninja-Jr dev, etc)'
        required: true
        default: 'Ninja-Jr dev'
        type: string
      auto_patch:
        description: 'Auto-patch A2DP library on failure?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  compile_sketch:
    name: Build lilygo-t-embed-cc1101 with Auto-Patch
    runs-on: ubuntu-latest
    env:
      BOARD_ENV: "lilygo-t-embed-cc1101"
      SHOULD_PATCH: ${{ github.event.inputs.auto_patch }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch }}
          token: ${{ secrets.SYNC_PAT }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-multilib libc6-dev-i386

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install requests esptool intelhex

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: Bruce-platformio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: Bruce-platformio-

      - name: Restore PIO Build Cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ github.workspace }}/.pio
          key: Bruce-pio-${{ env.BOARD_ENV }}-${{ github.run_id }}-${{ github.run_attempt }}
          restore-keys: |
            Bruce-pio-${{ env.BOARD_ENV }}-

      - name: Install PlatformIO and configure version
        run: |
          pip install platformio
          sed -i "s/-DBRUCE_VERSION=/-DBRUCE_VERSION='\"${{ github.event.inputs.version_name }}\"' ; /g" ./platformio.ini
          GIT_HASH=$(git describe --always --dirty 2>/dev/null || echo "unknown")
          sed -i "s|-DGIT_COMMIT_HASH='\"Homebrew\"'|!echo '-DGIT_COMMIT_HASH=\\\\\\\\\"${GIT_HASH}\\\\\\\\\"'|g" ./platformio.ini

      - name: Compile for lilygo-t-embed-cc1101
        id: compile
        run: |
          platformio run -e ${{ env.BOARD_ENV }}

      - name: Debug A2DP Library Location
        if: failure() && env.SHOULD_PATCH == 'true'
        run: |
          echo "=== DEBUG: Current directory ==="
          pwd
          echo ""
          echo "=== DEBUG: Listing .pio ==="
          ls -la .pio/ 2>/dev/null || echo "No .pio directory"
          echo ""
          echo "=== DEBUG: Listing .pio/libdeps ==="
          ls -la .pio/libdeps/ 2>/dev/null || echo "No .pio/libdeps directory"
          echo ""
          echo "=== DEBUG: Looking for ESP32-A2DP ==="
          find . -name "ESP32-A2DP" -type d 2>/dev/null
          echo ""
          echo "=== DEBUG: Looking for BluetoothA2DPCommon.h ==="
          find . -name "BluetoothA2DPCommon.h" -type f 2>/dev/null

      - name: Check A2DP Error
        if: failure() && env.SHOULD_PATCH == 'true'
        id: check_a2dp
        run: |
          HEADER=$(find . -name "BluetoothA2DPCommon.h" -type f 2>/dev/null | head -1) || true
          if [ -f "$HEADER" ]; then
            echo "$HEADER" > header_path.txt
            if grep -q "#error" "$HEADER"; then
              echo "true" > has_error.txt
            else
              echo "false" > has_error.txt
            fi
          else
            echo "" > header_path.txt
            echo "false" > has_error.txt
          fi

      - name: Create Patched A2DP Library
        if: failure() && env.SHOULD_PATCH == 'true'
        run: |
          HEADER_PATH=$(cat header_path.txt 2>/dev/null || echo "")
          HAS_ERROR=$(cat has_error.txt 2>/dev/null || echo "false")
          
          if [ -n "$HEADER_PATH" ] && [ "$HAS_ERROR" = "true" ]; then
            ORIG_HEADER="$HEADER_PATH"
            ORIG_DIR=$(dirname "$ORIG_HEADER")
            PATCHED_DIR="lib/ESP32-A2DP-patched"
            
            mkdir -p "$PATCHED_DIR"
            cp -r "$ORIG_DIR"/* "$PATCHED_DIR/" 2>/dev/null || true
            PATCHED_HEADER="$PATCHED_DIR/BluetoothA2DPCommon.h"
            
            if [ -f "$PATCHED_HEADER" ]; then
              cp "$PATCHED_HEADER" "$PATCHED_HEADER.bak"
              
              sed -i -E '/^[[:space:]]*#[[:space:]]*error.*[Pp]latform/{
                s/^([[:space:]]*#[[:space:]]*error.*)$/\1\/\/ [SMART-PATCH] Platform check disabled/
              }' "$PATCHED_HEADER"
              
              sed -i -E '/^[[:space:]]*#[[:space:]]*error.*[Uu]nsupported.*[Pp]latform/{
                s/^([[:space:]]*#[[:space:]]*error.*)$/\1\/\/ [SMART-PATCH] Unsupported platform check disabled/
              }' "$PATCHED_HEADER"
              
              sed -i -E '/^[[:space:]]*#[[:space:]]*error.*[Ss]upport.*[Pp]latform/{
                s/^([[:space:]]*#[[:space:]]*error.*)$/\1\/\/ [SMART-PATCH] Platform support check disabled/
              }' "$PATCHED_HEADER"
              
              sed -i -E '/^[[:space:]]*#[[:space:]]*if.*ARDUINO_ARCH_ESP32.*$/,/^[[:space:]]*#[[:space:]]*endif/{
                /^[[:space:]]*#[[:space:]]*if.*ARDUINO_ARCH_ESP32/{
                  s/^([[:space:]]*#[[:space:]]*if).*$/\1 1 \/\/ [SMART-PATCH] Force platform detection/
                }
              }' "$PATCHED_HEADER"
              
              sed -i -E '/^[[:space:]]*#[[:space:]]*ifdef.*ARDUINO.*$/,/^[[:space:]]*#[[:space:]]*endif/{
                /^[[:space:]]*#[[:space:]]*ifdef.*ARDUINO/{
                  s/^([[:space:]]*#[[:space:]]*ifdef).*$/\1 1 \/\/ [SMART-PATCH] Force ARDUINO detection/
                }
              }' "$PATCHED_HEADER"
              
              sed -i -E '/^[[:space:]]*#[[:space:]]*if.*CONFIG_IDF_TARGET_ESP32/,/^[[:space:]]*#[[:space:]]*define.*IS_VALID_PLATFORM/{
                /^[[:space:]]*#[[:space:]]*if.*CONFIG_IDF_TARGET_ESP32/{
                  s/^([[:space:]]*#[[:space:]]*if).*$/\1 1 \/\/ [SMART-PATCH] Force CONFIG_IDF_TARGET_ESP32/
                }
                /^[[:space:]]*#[[:space:]]*define.*IS_VALID_PLATFORM.*false/{
                  s/^([[:space:]]*#[[:space:]]*define.*IS_VALID_PLATFORM).*false.*$/\1 true \/\/ [SMART-PATCH] Force valid platform/
                }
              }' "$PATCHED_HEADER"
              
              SMART_PATCH_COUNT=$(grep -c "SMART-PATCH" "$PATCHED_HEADER")
              echo "Applied $SMART_PATCH_COUNT smart platform patches"
              
              cpp -fsyntax-only "$PATCHED_HEADER" 2>/dev/null || echo "Syntax check continuing"
            else
              echo "ERROR: Could not find patched header at $PATCHED_HEADER"
              exit 1
            fi
            
            echo '{' > "$PATCHED_DIR/library.json"
            echo '  "name": "ESP32-A2DP-patched",' >> "$PATCHED_DIR/library.json"
            echo '  "version": "1.8.8-bruce-smart-patched",' >> "$PATCHED_DIR/library.json"
            echo '  "description": "ESP32-A2DP smart-patched for Bruce firmware - targets only platform checks",' >> "$PATCHED_DIR/library.json"
            echo '  "keywords": ["a2dp", "bluetooth", "audio", "esp32", "smart-patch"],' >> "$PATCHED_DIR/library.json"
            echo '  "authors": [{"name": "Phil Schatzmann", "maintainer": true}],' >> "$PATCHED_DIR/library.json"
            echo '  "frameworks": ["arduino"],' >> "$PATCHED_DIR/library.json"
            echo '  "platforms": ["espressif32"]' >> "$PATCHED_DIR/library.json"
            echo '}' >> "$PATCHED_DIR/library.json"
            
            echo "Smart platform patching complete"
          fi

      - name: Update platformio.ini with Patched Library
        if: failure() && env.SHOULD_PATCH == 'true'
        run: |
          HEADER_PATH=$(cat header_path.txt 2>/dev/null || echo "")
          HAS_ERROR=$(cat has_error.txt 2>/dev/null || echo "false")
          
          if [ -n "$HEADER_PATH" ] && [ "$HAS_ERROR" = "true" ]; then
            cp platformio.ini platformio.ini.backup
            
            python3 << 'EOF'
with open('platformio.ini', 'r') as f:
    config_lines = f.readlines()

new_lines = []
in_lib_deps_section = False
modified = False

for line in config_lines:
    stripped = line.strip()
    
    if stripped.startswith('lib_deps'):
        in_lib_deps_section = True
    
    if in_lib_deps_section and ('ESP32-A2DP' in line or 'pschatzmann/ESP32-A2DP' in line):
        if any(line.strip().startswith(prefix) for prefix in [
            'pschatzmann/ESP32-A2DP',
            'https://github.com/pschatzmann/ESP32-A2DP',
            'ESP32-A2DP @'
        ]):
            new_lines.append('    lib/ESP32-A2DP-patched\n')
            modified = True
            continue
    
    if in_lib_deps_section and stripped == '' and len(new_lines) > 0 and new_lines[-1].strip() == '':
        in_lib_deps_section = False
    
    new_lines.append(line)

if modified:
    with open('platformio.ini', 'w') as f:
        f.writelines(new_lines)
    print("Successfully updated platformio.ini to use local patched library")
else:
    print("No ESP32-A2DP dependencies found to replace")
EOF
          fi

      - name: Verify platformio.ini Update
        if: failure() && env.SHOULD_PATCH == 'true'
        run: |
          HEADER_PATH=$(cat header_path.txt 2>/dev/null || echo "")
          HAS_ERROR=$(cat has_error.txt 2>/dev/null || echo "false")
          
          if [ -n "$HEADER_PATH" ] && [ "$HAS_ERROR" = "true" ]; then
            echo "=== Verifying platformio.ini update ==="
            echo ""
            echo "Checking for ESP32-A2DP references in platformio.ini:"
            grep -n "ESP32-A2DP" platformio.ini || echo "No ESP32-A2DP references found"
            echo ""
            echo "Checking for patched library reference:"
            grep -n "lib/ESP32-A2DP-patched" platformio.ini || echo "Patched library reference not found"
            echo ""
            echo "Current lib_deps section content:"
            grep -A 10 "lib_deps" platformio.ini | head -15
          fi

      - name: Commit and Push Patched Library
        if: failure() && env.SHOULD_PATCH == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          HEADER_PATH=$(cat header_path.txt 2>/dev/null || echo "")
          HAS_ERROR=$(cat has_error.txt 2>/dev/null || echo "false")
          
          if [ -n "$HEADER_PATH" ] && [ "$HAS_ERROR" = "true" ]; then
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git add lib/ESP32-A2DP-patched/
            git add platformio.ini
            if ! git diff --cached --quiet; then
              git commit -m "ðŸ”§ Smart Auto-patch: Add patched ESP32-A2DP library
              
              Smart platform detection patched for Bruce firmware
              - Targeted patches only disable platform checks
              - Auto-generated by GitHub Actions run #${{ github.run_number }}
              
              Build env: ${{ env.BOARD_ENV }}
              Version: ${{ github.event.inputs.version_name }}
              Patches applied: $(grep -c 'SMART-PATCH' lib/ESP32-A2DP-patched/BluetoothA2DPCommon.h 2>/dev/null || echo 'unknown')"
              git push origin ${{ github.event.inputs.target_branch }}
            fi
          fi

      - name: Retry Build with Patched Library
        if: failure() && env.SHOULD_PATCH == 'true'
        run: |
          HEADER_PATH=$(cat header_path.txt 2>/dev/null || echo "")
          HAS_ERROR=$(cat has_error.txt 2>/dev/null || echo "false")
          
          if [ -n "$HEADER_PATH" ] && [ "$HAS_ERROR" = "true" ]; then
            echo "=== Starting retry build with patched library ==="
            echo "Using patched library at: lib/ESP32-A2DP-patched"
            platformio run -e ${{ env.BOARD_ENV }}
          fi

      - name: Save PIO Build Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ github.workspace }}/.pio
          key: Bruce-pio-${{ env.BOARD_ENV }}-${{ github.run_id }}-${{ github.run_attempt }}

      - name: Upload Binary Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Bruce-${{ env.BOARD_ENV }}-${{ github.event.inputs.version_name }}
          path: |
            Bruce-*.bin
            Bruce-*.elf
            Bruce-*.map
          retention-days: 30
          if-no-files-found: error

      - name: Display Build Info
        if: always()
        run: |
          if ls Bruce-*.bin 1> /dev/null 2>&1; then
            echo "Build successful!"
            echo "Environment: ${{ env.BOARD_ENV }}"
            echo "Version: ${{ github.event.inputs.version_name }}"
            echo "Git Hash: $(git describe --always --dirty 2>/dev/null || echo 'unknown')"
            ls -la Bruce-*.* 2>/dev/null || echo "No Bruce files"
          else
            echo "Build failed"
            echo "A2DP patching attempted: ${{ env.SHOULD_PATCH }}"
          fi
